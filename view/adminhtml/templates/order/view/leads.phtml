<?php
/**
 * Extend Warranty
 *
 * @author      Extend Magento Team <magento@guidance.com>
 * @category    Extend
 * @package     Warranty
 * @copyright   Copyright (c) 2021 Extend Inc. (https://www.extend.com/)
 */

/** @var Magento\Sales\Block\Adminhtml\Order\View $block */
/** @var Magento\Framework\Escaper $escaper */
/** @var Extend\Warranty\ViewModel\Warranty $viewModel */
$viewModel = $block->getViewModel();
$parentBlock = $block->getParentBlock();
$item = $parentBlock->getItem();
$leadToken = json_decode($item->getLeadToken()) === NULL ? [] : json_decode($item->getLeadToken(), true);
?>

<?php if ($viewModel->isExtendEnabled() && $viewModel->isLeadEnabled() && !empty($leadToken)): ?>
    <td>
        <div id="extend-offer-<?= $item->getSku(); ?>"></div>
    </td>
    <script type="text/javascript">
        require(['jquery','mage/url'], function($, urlBuilder){
            Extend.buttons.renderSimpleOffer('#extend-offer-<?= $item->getSku() ?>', {
                referenceId: '<?= $item->getSku() ?>',
                onAddToCart: function (opts) {

                    const plan = opts.plan;
                    if (plan) {
                        let parentId = "<?= $item->getOptionByCode('simple_product') ? $item->getProductId() : '' ?>";
                        let url      = "<?= $block->getUrl('extend/warranty/leads') ?>";
                        let leadToken = "<?= implode(", ", $leadToken); ?>";
                        let customerEmail = "<?= $block->getOrder()->getCustomerEmail();?>";
                        let order = "<?= $block->getOrder()->getId();?>"
                        plan.product = '<?= $item->getSku() ?>';

                        $.post(url, {
                            customerEmail: customerEmail,
                            order: order,
                            warranty: plan,
                            option: parentId,
                            leadToken : leadToken
                        }).done(function (data) {
                            if (data.status == "success") {

                                var url = urlBuilder.build("sales/order/view");
                                console.log(url);
                                window.location.href = url;
                            } else {
                                console.log("Oops! There was an error adding the protection plan.");
                            }
                        });
                    }
                }
            });
        });
    </script>
<?php endif; ?>
